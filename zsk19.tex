			
% Template for Elsevier CRC journal article
% version 1.2 dated 09 May 2011

% This file (c) 2009-2011 Elsevier Ltd.  Modifications may be freely made,
% provided the edited file is saved under a different name

% This file contains modifications for Procedia Computer Science
% but may easily be adapted to other journals

% Changes since version 1.1
% - added "procedia" option compliant with ecrc.sty version 1.2a
%   (makes the layout approximately the same as the Word CRC template)
% - added example for generating copyright line in abstract

%-----------------------------------------------------------------------------------

%% This template uses the elsarticle.cls document class and the extension package ecrc.sty
%% For full documentation on usage of elsarticle.cls, consult the documentation "elsdoc.pdf"
%% Further resources available at http://www.elsevier.com/latex

%-----------------------------------------------------------------------------------

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                                          %%
%% Important note on usage                                  %%
%% -----------------------                                  %%
%% This file should normally be compiled with PDFLaTeX      %%
%% Using standard LaTeX should work but may produce clashes %%
%%                                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% The '3p' and 'times' class options of elsarticle are used for Elsevier CRC
%% Add the 'procedia' option to approximate to the Word template
%\documentclass[3p,times,procedia]{elsarticle}
\documentclass[3p,times]{elsarticle}

%% The `ecrc' package must be called to make the CRC functionality available
\usepackage{ecrc}
\usepackage{subfigure}  

%% The ecrc package defines commands needed for running heads and logos.
%% For running heads, you can set the journal name, the volume, the starting page and the authors

%% set the volume if you know. Otherwise `00'
\volume{00}

%% set the starting page if not 1
\firstpage{1}

%% Give the name of the journal
\journalname{European Journal of Operational Research}

%% Give the author list to appear in the running head
%% Example \runauth{C.V. Radhakrishnan et al.}
\runauth{}

%% The choice of journal logo is determined by the \jid and \jnltitlelogo commands.
%% A user-supplied logo with the name <\jid>logo.pdf will be inserted if present.
%% e.g. if \jid{yspmi} the system will look for a file yspmilogo.pdf
%% Otherwise the content of \jnltitlelogo will be set between horizontal lines as a default logo

%% Give the abbreviation of the Journal.  Contact the journal editorial office if in any doubt
\jid{procs}

%% Give a short journal name for the dummy logo (if needed)
\jnltitlelogo{EJOR}

%% Provide the copyright line to appear in the abstract
%% Usage:
%   \CopyrightLine[<text-before-year>]{<year>}{<restt-of-the-copyright-text>}
%   \CopyrightLine[Crown copyright]{2011}{Published by Elsevier Ltd.}
%   \CopyrightLine{2011}{Elsevier Ltd. All rights reserved}
\CopyrightLine{2019}{Published by Elsevier Ltd.}

%% Hereafter the template follows `elsarticle'.
%% For more details see the existing template files elsarticle-template-harv.tex and elsarticle-template-num.tex.

%% Elsevier CRC generally uses a numbered reference style
%% For this, the conventions of elsarticle-template-num.tex should be followed (included below)
%% If using BibTeX, use the style file elsarticle-num.bst

%% End of ecrc-specific commands
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% The amssymb package provides various useful mathematical symbols
\usepackage{graphicx}
%% `Elsevier LaTeX' style
%%%%%%%%%%%%%%%%%%%%%%%
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{natbib}
%\usepackage{apalike}
\usepackage{enumerate}
\usepackage{xcolor}
\bibliographystyle{apalike}

\usepackage[figuresright]{rotating}
\usepackage{tikz}
\newcommand*\circled[1]{\tikz[baseline=(char.base)]{
   \node[shape=circle,draw,inner sep=0.9pt] (char) {#1};}}


\usepackage{enumitem}
\newlist{steps}{enumerate}{1}
\setlist[steps, 1]{label = \textit{Step \arabic*:}}
% put your own definitions here:
%   \newcommand{\cZ}{\cal{Z}}

%   ...

% add words to TeX's hyphenation exception list
%\hyphenation{author another created financial paper re-commend-ed Post-Script}

% declarations for front matter

\begin{document}

\begin{frontmatter}

%% Title, authors and addresses

%% use the tnoteref command within \title for footnotes;
%% use the tnotetext command for the associated footnote;
%% use the fnref command within \author or \address for footnotes;
%% use the fntext command for the associated footnote;
%% use the corref command within \author for corresponding author footnotes;
%% use the cortext command for the associated footnote;
%% use the ead command for the email address,
%% and the form \ead[url] for the home page:
%%
%% \title{Title\tnoteref{label1}}
%% \tnotetext[label1]{}
\author{Martin \v Sm\' id}\corref{cor1}\fnref{label1}
\author{Franti\v sek Zapletal\fnref{label2}}
%% \ead{email address}
%% \ead[url]{home page}
%% \fntext[label2]{}
%% \cortext[cor1]{}
%% \address{Address\fnref{label3}}
%% \fntext[label3]{}

\dochead{}

\title{Towards Optimal Emissions Portfolio via Multi-stage Stochastic Programming using the Markov SDDP Algorithm}

%\author{Franti\v sek Zapletal}
\address{Czech Academy of Sciences, Institute of Information Theory and Automation, Pod Vod\' arenskou v\v e\v z\' i 4, Prague, Czech Republic, smid@cas.utia.cz \fnref{label2} }
\address{V\v SB -- Technical University of Ostrava, Sokolska 33, Ostrava, Czech Republic,
                frantisek.zapletal@vsb.cz \fnref{label2} }

\begin{abstract}

Emissions trading within the Emissions Trading Scheme of the European Union (EU ETS) influences European industrial companies since 2005. The companies must choose their strategy how to reduce the costs of emissions allowances as possible. The changing system’s conditions and volatile price of allowances make this decision very tough. Despite several studies devoted to the relationship between the EU ETS and companies have already been published, there is still a gap in this field. Namely, the published studies have been substantially simplified so far, e.g., by ignoring the risk of driving parameters (prices of products, or allowances), omiting existence of derivatives on allowances, or taking only one decision period into consideration. In this paper, we provide a complex stochastic optimization model, which avoids the mentioned simplifications. The resulting optimization model is a large scale stochastic optimization model requiring an efficient algorithm to be solved in reasonable time. Namely, we use the Markov Stochastic Dual Dynamic Programming algorithm (MSDDP) to find the optimal solution. The model is verified using the data of a real-life industrial company. 

%The results show that ... TBD.


%Nezapomen hned tady rict, ze clanek navazuje na Tashizaku s Bertrandem
\end{abstract}

\begin{keyword}
emissions trading \sep EU ETS \sep stochastic programming \sep multi-stage \sep SDDP \sep EUA.
%% PACS codes here, in the form: \PACS code \sep code

%% MSC codes here, in the form: \MSC code \sep code
%% or \MSC[2008] code \sep code (2000 is the default)

\end{keyword}

\end{frontmatter}


\global\long\def\E{\mathbb{E}}%
\global\long\def\R{\mathbb{R}}%
\global\long\def\F{\mathcal{F}}%
\global\long\def\charf{\mathbf{1}}%
\global\long\def\barxi{\overline{\xi}}%
\global\long\def\X{\mathcal{X}}%

\section{Introduction}
\label{sec:1}

Emissions trading within the European Emissions Trading System (EU ETS) is the main tool of the EU environmental policy since 2005. Rules and settings of the EU ETS are given by several EU directives, namely \citet{DIR1}, \citet{DIR4}, \citet{DIR3} and \citet{DIR9}. This system is based on obligation for companies to use emission allowances (EUAs) to cover their CO$_2$ emissions, thus it is a source of additional financial risk and costs related with trading the allowances. Many studies have been already devoted to analysis of the EU ETS' impact on companies with the same results -- this effect cannot be ommited and should be involved in strategic planning, see \citet{zhang},\citet{SMI}, or \citet{anor}. This is even enhanced by several external shocks, changes in the trading rules for the next trading periods, and trends in heavy industry, which, all together, resulting in rapid increase in allowance prices during 2017 and 2018.

Up to now, each published model optimizing the behaviour of industrial companies regarding the emissions trading has always been simplified at least at one important factor identified by \citet{anor}:
\begin{enumerate}
\item[a)] multi-period environment allowing for use of banking (transfering the allowances to following time periods);
\item[b)] uncertain demand for products (the demand is a crucial factor for production, and thus for amount of emissions too);
\item[c)] uncertain EUA price (since the EU ETS is a cap-and-trade system, the allowance price is essential);
\item[d)] involving all available derivatives for allowances (futures and options).
\end{enumerate}     

\begin{table}[htbp]               
\centering
\begin{tabular}{l|l}\hline
Authors & Omitted factors\\ \hline
Lemathe and Balakrishnan (2005)& a,b,c,d\\
Rong and Landhelma (2007)& d\\
Sirikitputtisak et al. (2009)& b,c,d\\
Mirzaesmaeeli et al. (2010)& b,c,d\\
Gong and Zhou (2013) & d\\
Tang and Song (2013)& c,d\\
Zhang and Xu (2013)& a,c,d\\
Zapletal and \v Sm\' id (2016)& a,d \\
Zapletal, \v Sm\' id and Kopa (2019)& d (options)\\\hline

\end{tabular}
\caption{The review on published optimization models devoted to company's behaviour regarding the emissions trading}
\label{tab1}
\end{table}


Tab. \ref{tab1} provides a review of the available models and their simplifying assumprions, according to the list above. The simplifications can stem from two main reasons. First, the authors established their model under the conditions valid at that time considering both, rules of the EU ETS and state of economy. For instance, financial derivatives could not be used by companies in the beginning of the EU ETS, banking of allowances was not allowed between the first (2005-2008) and the second (2009-2012) trading phase, see \citet{zapletal3}, and during the deep economic crisis the companies generated rather the profit than additional loss from emissions trading, due to very low levels of demands and EUA price. Second, the authors were aware of all the mentioned factors, but they have decided for simplifications just to keep the size of the models small enough to be still solvable, like in the case of \citet{anor}.

In this paper, we establish a complex stochastic optimization model involving the factors (a)-(d). This model is big enough to be solved using the standard algorithms of stochastic programming. Therefore, we apply the Stochastic Dual Dynamic algorithm, which is known to be able to of large stochastic programming models efficiently, see \citet{pereira1991multi}. In particular, we use its modification for the case of Hidden Markov Models \citep{philpott2013solving}. Moreover, we work with the latest available input data (till 12/2018), which even increase credibility of the results. 

The proposed model is applied to one real-world Czech steel company, for which we explore the impact of the factors (a)-(d) on costs of emissions trading and the associated financial risk. Furthermore, we focus on optimal portfolio of emission allowances and impact of the emissions trading on production of the modelled company. This analysis is also supported by sensitivity analysis performed for the selected inpiut values. 

%The results show that...TBD.

%The rest of this paper is organized as follows. 


\section*{Description of the problem}

A steel company decides on ways of covering their emissions $Y_{1},\dots,Y_{T}$ stemming from their exogenously given production, at times $1,\dots,T$,
by a single type of allowances. At each $t=1,\dots,T$, $r_{t}$ allowances
is given (grandfathered) to the company for free. Further, allowances
may be bought (sold) at a secondary market at any time $t=0,\dots,T$.
The allowances may be saved (banked) for future periods. 

In addition to the spots, at each $t=0,\dots,T-1,$ futures with maturities
$t+1,t+2.\dots.T,$ may be bought. Moreover, at each $t=0,\dots,T-1$, call and put options with maturities $t+1,t+2.\dots.T,$
and strike prices $K_{1},\dots,K_{\kappa}$, $L_{1},\dots,L_{\kappa}$, respectively, may be bought at $t$.
In principle, the options
need not be exercised at the time of their maturity; however, as we neglect transaction costs, exercising only some options is
always no better than exercising all options and selling the
useless ones; thus, we may assume all the options are exercised. The company may trade with the allowances and their derivatives freely; however, they may no take short positions and they may not sell futures (we do not allow selling the futures to avoid speculations prevented by margin requirements  in practise, which we neglect here).

%The company may fund their emission trading by loans with an interest
%rate $\varrho$. The insufficiency of cash at $T$ is penalized by
%a prohibitive interest rate $\iota$.

The company is risk-averse minimizing the discounted nested mean-CVaR
risk measure, applied to the difference of the profits from the production and the costs of emission trading. 

\subsection*{Preliminary analysis}

In this Section, we illustrate the problem of the optimal emission covering on a simplified one-stage example. 

Say that the emission amount $Y_1$ has to be covered at time one. At the time zero, spots with price $P_0$ and futures with price $Q_0$ cam be bought.  Further, call-- and put options with strike price $K$, $L$, respectively, may be bought at time zero for prices (option premiums) $b$, $c$, respectively. Finally, buy or sell the spots for random price $P_1$ at time one.

The distributions of $P_1$ and $Y_1$ are atomic, with atoms $p_1<\dots<p_m$, $y_1< \dots < y_n$, respectively, such that any $\mathbb{P}[P_1=p_i,Y_1=yj] > 0$ for any $1\leq i \leq m$, $1\leq j \leq n$. 
The prices $b,c,P_0$ and $Q_0$ are deterministic.

First let us observe that buying a future at time zero is equivalent to buying the spot at time zero up to the price and time of payment,\footnote{Usually, the spots are paid at the time of their purchase  while (the majority) of future price is paid at the future's maturity.} because the result is always having a spot a time one, either for $Q_0$, or for $(1+\iota) P_0$, where $\iota$ is the interest rate of borrowing. Thus, the cheaper option will always be used rather than the other one, so the possibility of buying spots at time zero may be neglected

We do not study all combinations of the instruments in this simplified example. Rather, we discuss using futures, call options, and put options, separately. As a risk measure, we use the supremum (worst case) risk measure, which we denote by $\sigma$. Although it is different from the mean-CVaR, which is discussed later, it is quite similar (it penalizes the worst cases), and it coincides with CVaR for the atomic distributions with the probabilities of the atoms being no less than the CVaR level. 

Starting the first case, assume that $x$ futures is bought at time zero, resulting in costs 
$$
C_x = x Q_0+(Y_1-x) P_1
$$
with
$$
\sigma(C_x)=x Q_0 + \sup_{i} \sup_j \left\{ (y_j-x) p_i \right\}
=x Q_0 + \sup_{i} \left\{ (y_n-x) p_i \right\}
\\
=\begin{cases}
x Q_0 + (y_n-x) p_m & x \leq y_n\\
x Q_0 + (y_n-x) p_1 & x \leq y_n\\
\end{cases}
$$
If we, quite naturally, assume that $p_1 < Q_0 < p_m$, then both the branches are minimized at $x=y_n$, giving 
$$\sigma_F=\min_{x\geq 0}\sigma(C_x)= Q_0y_n=Q_0\sup Y_1.$$
Further, assume that the strike price $K$ of the call option coincidies with some atom $p_i$. If $x$ such options are bought at time zero, then the costs are
$$
D_x = bx + (Y_1-x)P_1 + x \min(P_1,K) 
$$
with 
\begin{multline*}
\sigma(D_x)=bx +\sup_{i} \sup_j \left\{ (y_j-x) p_i + x \min(p_i,K)\right\} 
=
bx +\sup_{i} \left\{ (y_n-x) p_i + x \min(p_i,K)\right\} 
\\
=bx +\left(\sup_{p_i \leq K } 
y_np_i
\vee
\sup_{p_i \geq K } 
\left\{ (y_n-x) p_i + x K\right\}
 \right)
=b x +  
\left[y_n K \vee d(x)\right],
\qquad  
d(x)=\begin{cases}
(y_n-x) p_m + xK
& x \leq y_n \\
y_n K & x \geq y_n.
\end{cases}
\end{multline*}
i.e.
$$
\sigma(D_x)=
\begin{cases}
 bx + [y_n K \vee (y_n p_m + x(K-p_m))] =  (bx +y_n K) \vee (y_n p_m + x(b+K-p_m)) & x \leq y_n\\
 b x + y_n K & x \geq y_n
 \end{cases}.
$$
If $b + K \leq p_m $ then the first branch is no less than
$$(bx +y_n K) \vee [y_n p_m + y_n(b+K-p_m)]=(bx +y_n K) \vee (y_n(b+K)) 
=y_n(b+K)
$$
where the bound is attained by $x=y_n$. As the second branch is no less than 
$y_n(b +K)$, we have that 
$$
\sigma_C=\min_x \sigma(C_x)=(b+K)\sup Y_1
$$
If, on the other hand, $b + K> p_m $, then the first branch has lower bound $y_n K \vee y_n p_m=y_n p_m$, attained by $x=0$, while the second branch is no less than $y_n(b+K)$, i.e. $\sigma(D_x) \geq y_n p_m$, which is attained by $x=0$, giving
$
\sigma_C=y_np_m$. Together, this gives
$$
\sigma_C=y_n[p_m \wedge (K + b)].
$$
with the optimal solution being $y_n$ if $b + K \leq p_m$ and being zero otherwise.

Finally, assume that $x$ put options is bought at time zero, leading to the costs
$$
E_x = cx + (Y_1 + x) P_1 - x \max(P_1,K).
$$
We have
\begin{multline*}
\sigma(E_x)= cx + \sup_i \sup_j \{(y_j + x) p_i - x \max(p_i,K)\}
=cx + \sup_i\{ (y_n + x) p_i - x \max(p_i,K)\}
\\
=cx + 
\left(
\sup_{p_i \leq K}\{ (y_n + x) p_i - x K\} \vee 
\sup_{p_i \geq K}\{ y_n p_i \}\right)
=cx + 
\left(
[(y_n + x) p_m - x K] \vee  y_n p_m \right)
\\=
\left(
[cx+y_np_m + (p_m-K) x] 
\vee 
[cx+ y_n p_m] 
\right)
\geq y_n p_m
\end{multline*}
where the bound is attained for $x=0$, i.e. put options will no way help to reduce risk.

Clearly, buying all the spots at time one leads to the costs $F = Y_1 P_1$ with $\sigma(F)=\sup P_1 \sup Y_1$.

Summarized, if we are to choose which instrument to use, we will choose futures if $Q_0 < K+b$ or call options otherwise. In both the cases. the amount of the instruments will correspond to the worst possible need for the emissions.

In the model we study in the present paper, the situation is much more complex: Mean-CVaR is used instead of the supremum, the random variables are continuous, and, most importantly, the problem is dynamic with the nested structure. Nevertheless, as it will be described below, the results given by the complex model are similar to a certain extent.

\subsection*{Problem definition}


As it was premised, the subject of decision is the emission trading. In particular, the decision variables at $t$ include the number $\Delta s_{t}$ of
the spot allowances purchased/sold at time $t$, the numbers $$\Delta f_{t}=(\Delta f_{t}^{t+1},\dots,\Delta f_{t}^{T})$$
of the futures with maturities $t+1,\dots,T$ purchased, and the numbers 
\[
\Delta \phi_{t}=\left[\begin{array}{ccc}
\Delta \phi_{t}^{t+1,1} & \dots & \Delta \phi_{t}^{T,1}\\
\vdots &  & \vdots\\
\Delta \phi_{t}^{t+1,\kappa} & \dots & \Delta \phi_{t}^{T,\kappa}
\end{array}\right],
\qquad
\Delta \psi_{t}=\left[\begin{array}{ccc}
\Delta \psi_{t}^{t+1,1} & \dots & \Delta \psi_{t}^{T,1}\\
\vdots &  & \vdots\\
\Delta \psi_{t}^{t+1,\mu} & \dots & \Delta \psi_{t}^{T,\mu}
\end{array}\right],
\]
of the call options, put options, respectively, purchased/sold; here, $\Delta \phi_t^{\tau,i}$/$\Delta \psi_t^{\tau,i}$ denotes the number of call/put options with maturity $\tau$ and strike price $K_i$ / $L_i$.

At $t=0$, the income of the company is
$$
y_0=-P_0\Delta s_0
- \sum_{\tau=1}^{T}\sum_{i=1}^{\kappa}B_0^{\tau,i}\Delta \phi_0^{\tau,i},
- \sum_{\tau=1}^{T}\sum_{i=1}^{\mu}C_0^{\tau,i}\Delta \psi_0^{\tau,i},
$$
while, at any $0<t\leq T$, the income is
\begin{multline*}
y_t  =X_t-P_t \Delta s_t
-\sum_{i=1}^{\kappa}\min(P_t,K_{i})\phi_{t-1}^{t,i}
+\sum_{i=1}^{\mu}\max(P_t,L_{i})\psi_{t-1}^{t,i}
-\sum_{\tau=0}^{t-1}Q_{\tau}^{t}\Delta f_{\tau}^t-\sum_{\tau=t+1}^{T}\sum_{i=1}^{\kappa}B_t^{\tau,i}\Delta\phi_t^{\tau-t,i}-
\sum_{\tau=t+1}^{T}\sum_{i=1}^{\mu}C_t^{\tau,i}\Delta\psi_t^{\tau-t,i}
\end{multline*}
Here, $f_t=\sum_{\tau=0}^t \Delta f^t_\tau$, 
$\phi_t=\sum_{\tau=0}^t \Delta \phi_\tau^t$ and $\psi_t=\sum_{\tau=0}^t \Delta \psi_\tau^t$. Further, $X_t\in \R_+$ is the profit from the production at time $t$, $Y_t \in \R_+$ is the amount of the emissions at $t$, $P_t\in\R_{+}$ is the spot price at time $t$, $Q_t^\tau \in \R_+$ is the price of the future with maturity $\tau$ at time $t$, and $B_t^{\tau,i}\in \R_+$ is the premium paid at $t$ for the call option with strike price $K_i$ and maturity $\tau$. 

Further, we assume that the overall loss exceeding a limit $R$ is penalized by a rate $\iota$, the penalty amounting to 
$$
w_T=\iota\left[\sum_{t=0}^T y_t - R\right]_-.
$$

Finally, we assume the decision criterion to be $\rho(-y_0,\dots,-y_T+w_T)$
where
$$
\rho(c_0,\dots,c_T)=\mu_1(\mu_2(\dots\mu_T(c_0+\varrho c_1+\dots+\varrho ^ T c_T)\dots));
$$
here, $\F_t$ is the information available at $t$, $\mu_t(Z)=(1-\lambda)\E(Z|\F_{t-1})+\lambda \mathrm{CVaR}_\alpha(Z|\F_{t-1})$, $0\leq \lambda \leq 1$ and $0<\alpha<1$ are constants and $\varrho$ is a discount factor.

\global\long\def\indep#1{{\perp\hspace{-2mm}\perp}#1}%

\section{Data}

$T=0$ odpovídá začátku 2018, $T=3$ (end of 2020)

For the spot prices $P$ and the spreads $Q$ we adopt model from (anor). In particular, we fit the evolution of $P$ by 
\[
P_{t}=P_{0}\exp\left\{ \sum\nolimits_{\tau=1}^t u_{\tau} \right\},
\qquad u_t \sim \mathcal{N}\left(
-\frac{\sigma^2}{2},\sigma^2
\right),\qquad 1\leq t \leq T, 
\]
with $\sigma=0.439$ where $u_{1},\dots,u_T$ are i.i.d., and
\[
Q^\tau_{t}=P_t\exp\{(\tau-t)(0.00974+v^\tau_{t})\},\qquad v^\tau_{t}\sim \mathcal{N}(0,\varsigma^2),\qquad 1\leq t< \tau,\quad 1\leq \tau \leq T,
	\]
with $\varsigma=0.010$ where $v^2_1,v_1^3,v_2^3,\dots$ are i.i.d., independent of $u_1,\dots,u_T$.

The initial prices are equal to 
$$P_0=7.77, \quad Q^1_0=7.81,\quad Q^2_0=7.87,\quad Q^3_0=7.97$$ %markets.businessinsider.com

Option prices $B^{\tau,i}_t$ are computed by the Black-Scholes formula with the implied volatility being a quadratic function of the strike price relative to the spot price. The shape of the function, depicted in Picture XX, has been estimated using 110 observations of actual option prices on ???market. As the risk-less rate ??? was taken. 

\pgfimage[width=7cm]{smile}

Our model of yearly profits $X$ (ih thousands of EUR) and emissions $Y$ (in metric tonnes) was estimated using their monthly hypothetical historical values from 2014 to 2016, as 
\begin{equation}
\left[X_t
\atop
Y_t
\right]
=\left[37,847.73
\atop
232,561.57
\right]+
\left[
\begin{array}{cc}
0.6981 & -0.1211 \\
1.712 & -0.2638
\end{array}
\right]
\left[X_{t-1}
\atop
Y_{t-1}
\right]
 + e_t,\qquad e_t = \mathcal{N}\left(0,V\right)  
\end{equation}
where $e_1,e_2,\dots$ are i.i.d. and $V$ is a variance matrix defined by standard deviations $7,968$ and $25,499$ and correlation $0.7368$. As the initial values, we took
$$
X_0 = 33,735,\qquad Y_0 = 246,974.
$$
See Appendix for the construction of the model for $X$ and $Y$. 

We further assume that, at any $t$, the company observes the history of $P,Q,X,Y$ up to $t$, and they are  partially informed about $X$ and $Y$ one step ahead, namely that 
$$
e_t = f_t+g_t, \qquad f_t \sim \mathcal{N}(0,\omega V), 
\qquad
g_t \sim \mathcal{N}(0,(1-\omega) V),f_t \indep g_t,\qquad 1 \leq t \leq T,
$$
for some $0\leq \omega \leq 1$, and
$$
\F_t = \sigma( (P_\tau,Q_\tau,X_\tau,Y_\tau)_{\tau \leq t}, f_{t+1} )
$$
		
\section{Solution}

As it is clear from the previous Section, random parameters $P$, $X$ and $Y$ are time dependent rather than conditionally independent given some Markov chain, as it is required for the Markov SDDP algorithm. As neither $X_t$ nor  $Y_t$ are multiplied by a decision variable in the constraints of the problem, their time-dependence may be circumvented by regarding them as decision variables, constrained by (\ref{xymodel}); the i.i.d. residuals from (\ref{xymodel}) then become new random parameter. As $P$ is multiplied by other decision variables in the constraints, this trick cannot be used here. Instead, we approximate $P$ by a Hidden Markov Process according to  \citep{smid2019solution}. As the residuals from (\ref{xymodel}) are i.i.d. and as  $Q^\bullet_t$ -- the remaining random parameters -- are functions of $P$ and i.i.d. series, it follows that the vector of the new random parameters is a Hidden Markov chain process, hence eligible for Markov SDDP. For more details, see \citet{smid2019solution}.




\section*{References}

\bibliography{bibl}

\appendix

\def\indep{\perp\hspace{-2mm}\perp}
\def\E{\mathbb{E}}
\def\var{\mathrm{var}}
\newtheorem{lemma}{Lemma}

\subsection{Model for Production Income and Emissions}

According to the expert in steel industry, the unit profit for steel products is influenced mainly by costs of inputs, namely, costs of coal, scrap and iron ore. The expertise showed that these three inputs represent approximately three quarters of variable costs of a steel company. Since we know the real values of selling prices and variable costs in 2014, we use the historical market data on costs of the mentioned three inputs, price indices for flat products, long products and steel semiproducts to estimate the values of unit profits, see (\ref{XX}).

\begin{equation}
x_{i,t}=p_i^* \cdot \bar{P}_t^{\bullet} - c_i^* \cdot \bigl(\rho^{O}\cdot\bar{C}_t^{O}+\rho^{S}\cdot\bar{C}_t^{S}+\rho^{I}\cdot\bar{C}_t^{I}+(1-\rho^{S}-\rho^{O}-\rho^{I})\bigr)
\label{XX}
\end{equation}
$\bullet\in\{F,L,M\}$ represents type of a steel product -- flat, long, or semiproduct, respectively; $\rho^S,\rho^O,\rho^I$ stand for a share of influence of scrap, coal and iron ore on total variable costs, respectively; $\bar{C}_t^{S},\bar{C}_t^{O},\bar{C}_t^{I}$ are costs levels for scrap, coal and iron ore at time $t$, adjusted with respect to the last known real value using (\ref{XX2}); $\bar{P}_t^{\bullet}$ is a selling price of particular steel product type at time $t$, adjusted in the same manner as the costs ($\bar{C}_t$); $p_i^*$ and $c_i^*$ are the last known real values of selling prices and variables costs of particular steel products of the modelled company (in 2014). 

\begin{equation}
\bar{C}_t^{\circ}=\frac{C_t^{\circ}}{c^{\circ *}},
\label{XX2}
\end{equation}
where $c^{\circ *}$ is a price level for commodity $\circ\in\{S,C,O\}$ in 12/2014 and $C_t^{\bullet}$ stands for a price level of this commodity at time $t$.

The time series of prices come from the Czech Steel Union's database. The expert has recommended to set $\rho^S=\rho^O=\rho^I=0.25$. This means that one quarter of variable costs of production is influenced by other factors (than the three considered raw materials), like labour costs, etc. In this study, this one quarter is taken as constant in time for the sake of simplicity.  
Highly improbable negative observations are truncated to zero, if they appear during the computation. 


TBD introduce y, TBD say that x is in thousands. TBD say that we need yearly data.

As all the correlations of any of $x_t,y_t$ with any of $p_t$, $p_{t-1}$  and correlations of any of $\Delta x_t,\Delta y_t$ with any of $\Delta P_t$, $\Delta P_{t-1}$ are insignificant, we model $X,Y$ alone, independently of $P$. The time series plots and xy--plots of processes $x_t,y_t$ and the processes of their first differences can be seen in Figures:

\pgfimage[width=5cm]{tsplot}
\pgfimage[width=5cm]{dtsplot}


\pgfimage[width=5cm]{xyplot}
\pgfimage[width=5cm]{dxyplot}

In can be clearly seen that the values of $x_t$ and $y_t$ ``go along'' as well as their first differences, so it is worth to model their evolution jointly. As the ADF tests rejected unit root hypothesis for both the series, we chose VAR model with the single lag to fit their time evolution:
\begin{equation}\label{xymodel}
z_t=C + A z_{t-1} + \varepsilon_t,\qquad 
z_t = \left[x_t \atop y_t\right],
\qquad C = \left[2306	.45\atop 12852.2\right],
\qquad 
A=\left[\begin{array}{cc}
1.26237 &  -0.158943\\
2.24683 & 0 
\end{array}\right]
\end{equation}
where $\mathrm{stdev}(\varepsilon^1_1)=809.6647$, $\mathrm{stdev}(\varepsilon^2_1)=4882.004$ and $\mathrm{corr}(\varepsilon^1_1,\varepsilon^2_1)=0.907$.  Note that the model reflects a natural delay of the emissions after the production. (TBD je to takhle?)

For the process of yearly sums:
$$
Z_s = \left[X_s\atop Y_s\right]
\qquad 
X_s = \sum_{\tau = 12(s-1)}^{12s} x_\tau,
\quad
Y_s =\sum_{\tau = 12(s-1)}^{12s} y_\tau
$$
we have that 
$$
Z_s|Z_{s-1},\dots,Z_1 = \mathcal{N}
\left(\mu_s,V_s\right)
$$
where
$$
\mu_s = D + E\E(z_{12(s-1)}|Z_{s-1},\dots,Z_1),
\qquad 
D 
=\left( \sum_{k=0}^{11} (12-k) A^k\right) C
% = \sum_{k=0}^{11}  ( \sum_{i=0}^{11-k} A^{i} ) C
% = \sum_{k=0}^{11}  ( \sum_{i=0}^{k} A^{i} ) C,
\qquad 
E = \sum_{k=1}^{12} A^{k},
$$
$$
V_s = E\var(z_{12(s-1)}|Z_{s-1},\dots,Z_1)E'+W,,
\qquad
W = \sum_{i=0}^{11}F_{i}\var(\varepsilon_1)F'_{i},
\qquad 
F_k= \sum_{i=0}^k A^i.
$$


\begin{proof} For any $t>1$ and $k>1$, we have,
$$z_{t+1}=C + A z_{t} + \varepsilon_{t+1}$$
$$z_{t+2}=(I+A)C + A^2 z_{t} + \varepsilon_{t+2}+ A \varepsilon_{t+1}$$
$$\dots$$
$$
z_{t+k} = (I+\dots+A^{k-1}) C + A^k z_t + \varepsilon_{t+k} + \dots + A^{k-1} \varepsilon_{t+1}.
$$
Summing this, we get 
$$
Z_s = D + E z_{12(s-1)}+\eta_s, 
\qquad
\eta_s = \sum_{k=0}^{11} F_k \varepsilon_{12s-k} 
$$


Clearly, $(Z_1,\dots,Z_s)$ is regular Gaussian, so $Z_s|Z_{s-1},\dots,Z_1$ is  Gaussian with
$$
\E(Z_{s}|Z_{s-1},\dots,Z_1)=
\E(D+Ez_{(s-1)12}+\eta_s|Z_{s-1},\dots,Z_1)
=D + E\E(z_{(s-1)12}|Z_{s-1},\dots,Z_1),
$$
$$
\var(Z_{s}|Z_{s-1},\dots,Z_1)=
\var(D+Ez_{(s-1)12}+\eta_s|Z_{s-1},\dots,Z_1)
=\var(\eta_s)+E\var(z_{(s-1)12}|Z_{s-1},\dots,Z_1) E'
$$
(note that $\eta_s\indep (Z_1,\dots,Z_{s-1})$). Finally, as $\varepsilon_t$ are i.i.d, we get 
$
\var(\eta_s) = \sum_{k=0}^{11} F_k \var(\varepsilon_1) F_k'.
$
\end{proof}
In our case, 
$$
D=\left[37,847.23
\atop
232,561.57
\right],
\qquad
E = 
\left[
\begin{array}{cc}
8.37724 & -1.45331 \\
20.54408 & -3.16534
\end{array}
\right],
\qquad 
W = w' 
\left[
\begin{array}{cc}
1 & 0.7369 \\
0.7369 & 1
\end{array}
\right]w,
\qquad 
w =
\left[7,967.99
\atop
25,499.00
\right],
$$
The computation of  the conditional expectation and the conditional variance of $z_{12(s-1)}$ is possible (by the formula for the conditional distribution f a Gaussian subvector), yet complicated. Thus and as the influence of these term is not great, we use an approximation $\E(z_{12(s-1)}|Z_{s-1},\dots,Z_1) \doteq \E(\frac{Z_{s-1}}{12}|Z_{s-1},\dots,Z_1) =\frac{Z_{s-1}}{12}$, $\var(z_{12(s-1)}|Z_{s-1},\dots,Z_1)\doteq \var(\frac{Z_{s-1}}{12}|Z_{s-1},\dots,Z_1)=0$ to get 
$$
Z_s =D+\frac{1}{12} E Z_{s-1} + e_s,\qquad e_s \sim \mathcal{N} (0,W)
$$
As the initial values (corresponding to the beginning of 2018) we take the linear forecast of $Z_0 = \sum_{k=1}^{12} z_{t+l}$ in the monthly model (\ref{xymodel}),  where $t$ corresponds to the beginning of $2017$.


\subsection{Solution of the Decision Problem}

Next we reformulate the decision problem into a form, which is more convenient for computation. 

Denote $e_t$ the amount of the allowances held (immediately after) $t$. Clearly, $e_0=\Delta s_0$ and 
\begin{equation}\label{eq:e}
e_t = e_{t-1}+\Delta s_t+r_t +
f_{t-1}^t
+\sum_{i=1}^{\kappa}\phi_{t-1}^{t,i}
-\sum_{i=1}^{\kappa}\psi_{t-1}^{t,i}
-Y_t,
\end{equation}
As $\Delta f^t_\tau=f^t_\tau-f^t_{\tau-1}$, and similarly $\phi$, and as $\Delta s$ may be expressed from (\ref{eq:e}), we can alternatively take $e,f,\phi$ as decision variables. Further, as, at any $t$, the payment for futures with maturity $t$ is equal to $\sum_{\tau=0}^{t-1} b_\tau$ where $b_\tau \in  \F_\tau$, we may assume, without a change of the decision criterion's value, that $\varrho^{t-\tau}c_\tau$ is paid at each $0\leq \tau < T$ instead of the whole amount at $t$.

Consequently, the problem may be reformulated as
\[
\min_{x_{t}\in\X_{t},x_t \in \F_t 0\leq t\leq T}\rho\left(-z_{0},\dots,-z_{T}\right)
\]
where $\F_t$ is the filtration induced by process
$\xi_{t}=(X_{t},Y_{t},P_{t},Q_{t},B_t)$, where
$$
\X_{t}=\{(e_{t}, f_{t},\phi_{t}): e_0 \geq 0, f_0\geq0,
\phi_{0} \geq0.\},\qquad 0\leq t < T,$$
$$
\X_T = \{e_T:e_T=0\},
$$
and
$$
z_0=-P_0e_0-\sum_{\tau=1}^{T}\varrho^{\tau}Q_0^{\tau} f_0^{\tau}-  \sum_{\tau=1}^{T}\sum_{i=1}^{\kappa}B_0^{\tau,i}\phi_0^{\tau,i}, 
$$
\begin{multline*}
z_t  =X_t-P_t \Delta s_t
-\sum_{i=1}^{\kappa}\min(P_t,K_{i})\phi_{t-1}^{t,i}
+\sum_{i=1}^{\kappa}\max(P_t,L_{i})\phi_{t-1}^{t,i}
-\sum_{\tau=t+1}^{T}\varrho^{\tau-t}Q_t^{\tau}(f_t^{\tau-t}
-f_{t-1}^{\tau-t})
\\-\sum_{\tau=t+1}^{T}\sum_{i=1}^{\kappa}B_t^{\tau,i}
(\phi_t^{\tau-t,i}-\phi_{t-1}^{\tau-t,i}),\qquad 0<t\leq T.
\end{multline*}
$$
\Delta s_t = e_t -e_{t-1}-r_t-
f_{t-1}^t
-\sum_{i=1}^{\kappa}\phi_{t-1}^{t,i}
+\sum_{i=1}^{\kappa}\psi_{t-1}^{t,i}
+Y_t
$$





\end{document}

PEREIRA, M. V. F. and PINTO, L. M. V. G. Multi-stage stochastic opti-
mization applied to energy planning. Mathematical Programming. 1991, vol.
52, pp. 359{375.

